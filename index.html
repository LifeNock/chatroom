<!DOCTYPE html>
<html>
<head>
  <title>RYB Chat</title>
  <link rel="icon" id="favicon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%235865f2'/><text x='50' y='68' text-anchor='middle' font-size='50'>‚õµ</text></svg>">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg-primary: #313338;
      --bg-secondary: #2b2d31;
      --bg-tertiary: #1e1f22;
      --bg-input: #383a40;
      --bg-hover: #3a3c41;
      --bg-mention: rgba(250, 168, 26, 0.1);
      --text-primary: #dbdee1;
      --text-secondary: #949ba4;
      --text-tertiary: #6d6f78;
      --accent: #5865f2;
      --accent-hover: #4752c4;
      --accent-light: rgba(88, 101, 242, 0.3);
      --success: #57ab5a;
      --danger: #ed4245;
      --danger-hover: #c93b3e;
      --warning: #f47067;
      --border: #4e5058;
    }

    [data-theme="christmas"] {
      --bg-primary: #1a3a1a;
      --bg-secondary: #2d1810;
      --bg-tertiary: #1e0f0a;
      --bg-input: #3a1f15;
      --bg-hover: #4a2f25;
      --bg-mention: rgba(255, 215, 0, 0.15);
      --text-primary: #f0e6d2;
      --text-secondary: #c4b5a0;
      --text-tertiary: #8a7a65;
      --accent: #c41e3a;
      --accent-hover: #a01830;
      --accent-light: rgba(196, 30, 58, 0.3);
      --success: #2d7d2d;
      --danger: #8b1a1a;
      --danger-hover: #6e1515;
      --warning: #d4af37;
      --border: #5a3a2a;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      display: flex;
      flex-direction: column;
      transition: background 0.3s, color 0.3s;
    }

    /* Auth Screen */
    .auth-container {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: var(--bg-primary);
    }

    .auth-box {
      background: var(--bg-secondary);
      padding: 32px;
      border-radius: 8px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }

    .auth-box h1 {
      text-align: center;
      margin-bottom: 8px;
      color: var(--text-primary);
      font-size: 24px;
    }

    .auth-box .subtitle {
      text-align: center;
      color: var(--text-secondary);
      margin-bottom: 24px;
      font-size: 14px;
    }

    .auth-box input {
      width: 100%;
      padding: 12px;
      margin-bottom: 12px;
      border: none;
      border-radius: 4px;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 15px;
    }

    .auth-box input::placeholder { color: var(--text-tertiary); }
    .auth-box input:focus { outline: 2px solid var(--accent); }

    .auth-box button {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 4px;
      background: var(--accent);
      color: white;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 12px;
      transition: background 0.15s;
    }

    .auth-box button:hover { background: var(--accent-hover); }

    .auth-box button.secondary {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-primary);
    }

    .auth-box button.secondary:hover { background: var(--bg-hover); }

    .auth-box .error {
      color: var(--warning);
      font-size: 13px;
      margin-bottom: 12px;
      text-align: center;
    }

    .auth-box .divider {
      text-align: center;
      color: var(--text-tertiary);
      margin: 16px 0;
      font-size: 13px;
    }

    /* Chat Container */
    .chat-container {
      display: none;
      flex-direction: column;
      height: 100vh;
    }

    .chat-container.active { display: flex; }

    .header {
      background: var(--bg-secondary);
      padding: 12px 16px;
      border-bottom: 1px solid var(--bg-tertiary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-icon {
      width: 24px;
      height: 24px;
      background: var(--accent);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .header h1 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .connection-status {
      margin-left: 8px;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      background: var(--success);
      color: #fff;
    }

    .connection-status.disconnected { background: var(--warning); }

    .header-right {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .online-users {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .online-dot {
      width: 8px;
      height: 8px;
      background: var(--success);
      border-radius: 50%;
    }

    .online-count { font-size: 12px; color: var(--text-secondary); }

    .user-menu {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background 0.15s;
      position: relative;
    }

    .user-menu:hover { background: var(--bg-hover); }

    .user-menu-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      color: white;
      overflow: hidden;
    }

    .user-menu-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .user-menu-name { font-size: 13px; color: var(--text-primary); }

    .dropdown {
      position: absolute;
      top: 50px;
      right: 16px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      padding: 8px;
      min-width: 180px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      display: none;
      z-index: 100;
    }

    .dropdown.active { display: block; }

    .dropdown-item {
      padding: 10px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .dropdown-item:hover { background: var(--bg-hover); }
    .dropdown-item.danger { color: var(--warning); }

    /* Online Users Panel */
    .online-panel {
      position: absolute;
      top: 50px;
      right: 100px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      padding: 12px;
      min-width: 200px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      display: none;
      z-index: 100;
    }

    .online-panel.active { display: block; }

    .online-panel h3 {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      text-transform: uppercase;
    }

    .online-user {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
    }

    .online-user-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 600;
      color: white;
      overflow: hidden;
      position: relative;
    }

    .online-user-avatar img { width: 100%; height: 100%; object-fit: cover; }

    .online-user-avatar .status-dot {
      position: absolute;
      bottom: -2px;
      right: -2px;
      width: 10px;
      height: 10px;
      background: var(--success);
      border-radius: 50%;
      border: 2px solid var(--bg-tertiary);
    }

    .online-user-name { font-size: 13px; color: var(--text-primary); }

    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    #messages::-webkit-scrollbar { width: 8px; }
    #messages::-webkit-scrollbar-track { background: var(--bg-secondary); border-radius: 4px; }
    #messages::-webkit-scrollbar-thumb { background: var(--bg-tertiary); border-radius: 4px; }

    .message {
      padding: 8px 12px;
      border-radius: 4px;
      animation: messageIn 0.2s ease-out;
      transition: background 0.1s;
      position: relative;
      display: flex;
      gap: 12px;
    }

    .message.pending { opacity: 0.6; }
    .message:hover { background: var(--bg-hover); }
    .message:hover .message-actions { opacity: 1; }
    .message.mentioned { background: var(--bg-mention); border-left: 3px solid var(--warning); }
    .message.editing { background: var(--accent-light); }

    @keyframes messageIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 600;
      color: white;
      flex-shrink: 0;
      overflow: hidden;
    }

    .message-avatar img { width: 100%; height: 100%; object-fit: cover; }

    .message-body { flex: 1; min-width: 0; }

    .message-header {
      display: flex;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 4px;
    }

    .username { font-weight: 600; font-size: 15px; cursor: pointer; }
    .username:hover { text-decoration: underline; }

    .timestamp { font-size: 11px; color: var(--text-secondary); }
    .edited-tag { font-size: 10px; color: var(--text-secondary); margin-left: 4px; }

    .message-content {
      font-size: 15px;
      line-height: 1.4;
      color: var(--text-primary);
      word-wrap: break-word;
    }

    .message-content img {
      max-width: 400px;
      max-height: 300px;
      border-radius: 8px;
      margin-top: 8px;
      cursor: pointer;
      transition: transform 0.1s;
      display: block;
    }

    .message-content img:hover { transform: scale(1.02); }

    .mention {
      background: var(--accent-light);
      color: #dee0fc;
      padding: 0 4px;
      border-radius: 4px;
      font-weight: 500;
      cursor: pointer;
    }

    .mention:hover { background: rgba(88, 101, 242, 0.5); }

    /* Message Actions */
    .message-actions {
      position: absolute;
      right: 8px;
      top: -16px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      display: flex;
      opacity: 0;
      transition: opacity 0.1s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .message-action {
      padding: 6px 10px;
      cursor: pointer;
      font-size: 12px;
      color: #b5bac1;
      border: none;
      background: none;
      transition: background 0.1s;
    }

    .message-action:hover { background: var(--bg-hover); color: #fff; }
    .message-action:first-child { border-radius: 4px 0 0 4px; }
    .message-action:last-child { border-radius: 0 4px 4px 0; }

    /* Reactions */
    .reactions {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 6px;
    }

    .reaction {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      background: var(--bg-hover);
      border-radius: 12px;
      font-size: 14px;
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.1s;
    }

    .reaction:hover { background: var(--border); }
    .reaction.active { background: var(--accent-light); border-color: var(--accent); }
    .reaction-count { font-size: 12px; color: var(--text-primary); }

    /* Reaction Picker */
    .reaction-picker {
      position: absolute;
      background: var(--bg-tertiary);
      border-radius: 8px;
      padding: 8px;
      display: none;
      gap: 4px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.4);
      z-index: 50;
    }

    .reaction-picker.active { display: flex; }

    .reaction-option {
      font-size: 20px;
      padding: 4px 8px;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.1s;
    }

    .reaction-option:hover { background: var(--bg-hover); }

    .reply-context {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 8px;
      margin-bottom: 4px;
      font-size: 13px;
      color: var(--text-secondary);
      border-left: 2px solid var(--border);
      background: rgba(0,0,0,0.1);
      border-radius: 0 4px 4px 0;
      cursor: pointer;
    }

    .reply-context:hover { background: rgba(0,0,0,0.2); }
    .reply-context .reply-author { color: #00a8fc; font-weight: 600; }

    .reply-context .reply-text {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 300px;
    }

    .user-color-1 { color: var(--warning); }
    .user-color-2 { color: var(--success); }
    .user-color-3 { color: #6cb6ff; }
    .user-color-4 { color: #dcbdfb; }
    .user-color-5 { color: #f69d50; }
    .user-color-6 { color: #fc8dc7; }

    /* Typing Indicator */
    #typingIndicator {
      padding: 8px 16px;
      font-size: 13px;
      color: var(--text-secondary);
      min-height: 28px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .typing-dots {
      display: flex;
      gap: 3px;
    }

    .typing-dots span {
      width: 6px;
      height: 6px;
      background: var(--text-secondary);
      border-radius: 50%;
      animation: typingBounce 1.4s infinite;
    }

    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typingBounce {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-4px); }
    }

    #replyBar {
      display: none;
      padding: 8px 16px;
      background: var(--bg-secondary);
      border-top: 1px solid var(--bg-tertiary);
      align-items: center;
      gap: 12px;
      animation: slideIn 0.15s ease-out;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    #replyBar.active { display: flex; }

    #replyBar .reply-preview { flex: 1; font-size: 13px; color: var(--text-secondary); }
    #replyBar .reply-preview strong { color: #00a8fc; }

    #replyBar .cancel-reply, #editBar .cancel-edit {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 18px;
      padding: 4px;
    }

    #replyBar .cancel-reply:hover, #editBar .cancel-edit:hover { color: #fff; }

    /* Edit Bar */
    #editBar {
      display: none;
      padding: 8px 16px;
      background: var(--bg-secondary);
      border-top: 1px solid var(--bg-tertiary);
      align-items: center;
      gap: 12px;
      animation: slideIn 0.15s ease-out;
    }

    #editBar.active { display: flex; }
    #editBar .edit-label { flex: 1; font-size: 13px; color: var(--accent); }

    #imagePreviewBar {
      display: none;
      padding: 8px 16px;
      background: var(--bg-secondary);
      border-top: 1px solid var(--bg-tertiary);
      align-items: center;
      gap: 12px;
      animation: slideIn 0.15s ease-out;
    }

    #imagePreviewBar.active { display: flex; }

    #imagePreviewBar img {
      max-height: 60px;
      max-width: 100px;
      border-radius: 4px;
    }

    #imagePreviewBar .preview-info { flex: 1; font-size: 13px; color: var(--text-secondary); }

    #imagePreviewBar .cancel-image {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 18px;
      padding: 4px;
    }

    #imagePreviewBar .cancel-image:hover { color: #fff; }

    .input-container { padding: 0 16px 24px; position: relative; }

    .input-wrapper {
      background: var(--bg-input);
      border-radius: 8px;
      display: flex;
      align-items: center;
      padding: 4px 12px;
    }

    .input-wrapper:focus-within { box-shadow: 0 0 0 2px var(--accent); }

    .upload-btn {
      background: none;
      border: none;
      color: #b5bac1;
      cursor: pointer;
      padding: 8px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.15s, background 0.15s;
      margin-right: 8px;
    }

    .upload-btn:hover { color: #fff; background: var(--border); }
    .upload-btn svg { width: 20px; height: 20px; }

    #messageInput {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text-primary);
      font-size: 15px;
      padding: 11px 0;
    }

    #messageInput::placeholder { color: var(--text-tertiary); }

    .char-count { font-size: 12px; color: var(--text-tertiary); margin-right: 8px; }
    .char-count.warning { color: var(--warning); }

    #sendBtn {
      background: var(--accent);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s;
    }

    #sendBtn:hover { background: var(--accent-hover); }
    #sendBtn:disabled { background: var(--border); cursor: not-allowed; }
    #sendBtn svg { width: 18px; height: 18px; }

    /* Mention Suggestions */
    .mention-suggestions {
      position: absolute;
      bottom: 100%;
      left: 16px;
      right: 16px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      padding: 8px 0;
      display: none;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: 0 -4px 16px rgba(0,0,0,0.4);
      z-index: 50;
    }

    .mention-suggestions.active { display: block; }

    .mention-suggestion {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      cursor: pointer;
      transition: background 0.1s;
    }

    .mention-suggestion:hover, .mention-suggestion.selected { background: var(--bg-hover); }

    .mention-suggestion-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      color: white;
      overflow: hidden;
    }

    .mention-suggestion-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .mention-suggestion-name { font-size: 14px; color: var(--text-primary); }

    .welcome { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
    .welcome h2 { color: var(--text-primary); font-size: 24px; margin-bottom: 8px; }
    .welcome p { font-size: 14px; }

    #newMsgBtn {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--accent);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      cursor: pointer;
      display: none;
      animation: fadeIn 0.2s;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateX(-50%) translateY(10px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    #imageModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 1000;
      cursor: zoom-out;
      align-items: center;
      justify-content: center;
    }

    #imageModal.active { display: flex; }
    #imageModal img { max-width: 90%; max-height: 90%; border-radius: 8px; }

    .upload-progress { font-size: 12px; color: var(--text-secondary); margin-right: 8px; }
    #fileInput, #avatarInput { display: none; }

    /* Profile Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 500;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active { display: flex; }

    .modal {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 24px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal h2 { color: var(--text-primary); margin-bottom: 20px; font-size: 20px; }

    .modal .avatar-upload {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal .avatar-preview {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      font-weight: 600;
      color: white;
      margin-bottom: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: opacity 0.15s;
    }

    .modal .avatar-preview:hover { opacity: 0.8; }
    .modal .avatar-preview img { width: 100%; height: 100%; object-fit: cover; }
    .modal .avatar-hint { font-size: 12px; color: var(--text-secondary); }

    .modal button {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 4px;
      background: var(--accent);
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 12px;
    }

    .modal button:hover { background: var(--accent-hover); }
    .modal button.cancel { background: transparent; color: var(--text-secondary); }
    .modal button.cancel:hover { color: var(--text-primary); }

    /* Delete Confirmation */
    .confirm-modal .modal {
      max-width: 320px;
      text-align: center;
    }

    .confirm-modal p { color: var(--text-secondary); margin-bottom: 20px; font-size: 14px; }
    .confirm-modal .btn-row { display: flex; gap: 12px; }
    .confirm-modal .btn-row button { flex: 1; margin-top: 0; }
    .confirm-modal .btn-danger { background: var(--danger); }
    .confirm-modal .btn-danger:hover { background: var(--danger-hover); }

    /* Theme Settings */
    .theme-section {
      margin-bottom: 24px;
    }

    .theme-section h3 {
      font-size: 14px;
      color: var(--text-primary);
      margin-bottom: 12px;
      font-weight: 600;
    }

    .theme-presets {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .theme-preset {
      flex: 1;
      padding: 12px;
      border: 2px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      background: var(--bg-tertiary);
    }

    .theme-preset:hover {
      border-color: var(--accent);
      background: var(--bg-hover);
    }

    .theme-preset.active {
      border-color: var(--accent);
      background: var(--accent-light);
    }

    .theme-preset-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .theme-preset-icon {
      font-size: 24px;
      margin-bottom: 4px;
    }

    .custom-theme-toggle {
      padding: 10px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .custom-theme-toggle:hover {
      background: var(--bg-hover);
    }

    .custom-theme-panel {
      display: none;
      gap: 12px;
    }

    .custom-theme-panel.active {
      display: grid;
      grid-template-columns: 1fr 1fr;
    }

    .color-input-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .color-input-group label {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .color-input-wrapper {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .color-input-wrapper input[type="color"] {
      width: 40px;
      height: 32px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: transparent;
    }

    .color-input-wrapper input[type="text"] {
      flex: 1;
      padding: 6px 8px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 12px;
      font-family: monospace;
    }

    .expand-icon {
      transition: transform 0.2s;
    }

    .expand-icon.expanded {
      transform: rotate(180deg);
    }
  </style>
</head>
<body>
  <!-- Auth Screen -->
  <div class="auth-container" id="authScreen">
    <div class="auth-box">
      <h1>‚õµ RYB Chat</h1>
      <p class="subtitle">Row Your Boat Team Chat</p>
      <div id="authError" class="error" style="display: none;"></div>
      <div id="loginForm">
        <input type="text" id="loginUsername" placeholder="Username" autocomplete="off">
        <input type="password" id="loginPassword" placeholder="Password">
        <button onclick="login()">Log In</button>
        <div class="divider">or</div>
        <button class="secondary" onclick="showRegister()">Create Account</button>
      </div>
      <div id="registerForm" style="display: none;">
        <input type="text" id="registerUsername" placeholder="Username" autocomplete="off">
        <input type="password" id="registerPassword" placeholder="Password">
        <input type="password" id="registerConfirm" placeholder="Confirm Password">
        <button onclick="register()">Create Account</button>
        <div class="divider">or</div>
        <button class="secondary" onclick="showLogin()">Back to Login</button>
      </div>
    </div>
  </div>

  <!-- Chat Screen -->
  <div class="chat-container" id="chatScreen">
    <div class="header">
      <div class="header-icon">‚õµ</div>
      <h1>RYB Chat</h1>
      <span class="connection-status" id="connectionStatus">Live</span>
      <div class="header-right">
        <div class="online-users" onclick="toggleOnlinePanel()" style="cursor:pointer;">
          <span class="online-dot"></span>
          <span id="onlineCountNum">0</span> online
        </div>
        <span class="online-count" id="messageCount"></span>
        <div class="user-menu" onclick="toggleDropdown()">
          <div class="user-menu-avatar" id="userMenuAvatar"></div>
          <span class="user-menu-name" id="userMenuName"></span>
        </div>
      </div>
      <div class="dropdown" id="dropdown">
        <div class="dropdown-item" onclick="openProfile()">
          <span>üë§</span> Edit Profile
        </div>
        <div class="dropdown-item" onclick="openThemeSettings()">
          <span>üé®</span> Theme Settings
        </div>
        <div class="dropdown-item danger" onclick="logout()">
          <span>üö™</span> Log Out
        </div>
      </div>
      <div class="online-panel" id="onlinePanel">
        <h3>Online</h3>
        <div id="onlineUsersList"></div>
      </div>
    </div>

    <div id="messages">
      <div class="welcome">
        <h2>Welcome to RYB Chat</h2>
        <p>This is the start of your conversation.</p>
      </div>
    </div>

    <div id="typingIndicator"></div>

    <button id="newMsgBtn" onclick="scrollToBottom()">New messages ‚Üì</button>

    <div id="replyBar">
      <div class="reply-preview">Replying to <strong id="replyToUser"></strong></div>
      <button class="cancel-reply" onclick="cancelReply()">√ó</button>
    </div>

    <div id="editBar">
      <div class="edit-label">‚úèÔ∏è Editing message</div>
      <button class="cancel-edit" onclick="cancelEdit()">√ó</button>
    </div>

    <div id="imagePreviewBar">
      <img id="imagePreview" src="">
      <div class="preview-info" id="previewInfo">image.png</div>
      <button class="cancel-image" onclick="cancelImage()">√ó</button>
    </div>

    <div class="input-container">
      <div class="mention-suggestions" id="mentionSuggestions"></div>
      <div class="input-wrapper">
        <input type="file" id="fileInput" accept="image/*">
        <button class="upload-btn" onclick="document.getElementById('fileInput').click()" title="Upload image">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <circle cx="8.5" cy="8.5" r="1.5"></circle>
            <polyline points="21 15 16 10 5 21"></polyline>
          </svg>
        </button>
        <input type="text" id="messageInput" placeholder="Message #ryb-chat" maxlength="500" autocomplete="off">
        <span class="char-count" id="charCount"></span>
        <span class="upload-progress" id="uploadProgress"></span>
        <button id="sendBtn" onclick="sendMessage()">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Image Modal -->
  <div id="imageModal" onclick="closeImageModal()">
    <img id="modalImage" src="">
  </div>

  <!-- Profile Modal -->
  <div class="modal-overlay" id="profileModal">
    <div class="modal">
      <h2>Edit Profile</h2>
      <div class="avatar-upload">
        <div class="avatar-preview" id="profileAvatarPreview" onclick="document.getElementById('avatarInput').click()"></div>
        <input type="file" id="avatarInput" accept="image/*">
        <span class="avatar-hint">Click to change avatar</span>
      </div>
      <button onclick="saveProfile()">Save</button>
      <button class="cancel" onclick="closeProfile()">Cancel</button>
    </div>
  </div>

  <!-- Theme Settings Modal -->
  <div class="modal-overlay" id="themeModal">
    <div class="modal">
      <h2>üé® Theme Settings</h2>
      
      <div class="theme-section">
        <h3>Presets</h3>
        <div class="theme-presets">
          <div class="theme-preset" data-theme="default" onclick="selectThemePreset('default')">
            <div class="theme-preset-icon">üåô</div>
            <div class="theme-preset-name">Default</div>
          </div>
          <div class="theme-preset" data-theme="christmas" onclick="selectThemePreset('christmas')">
            <div class="theme-preset-icon">üéÑ</div>
            <div class="theme-preset-name">Christmas</div>
          </div>
        </div>
      </div>

      <div class="theme-section">
        <div class="custom-theme-toggle" onclick="toggleCustomTheme()">
          <span>Custom Theme</span>
          <span class="expand-icon" id="expandIcon">‚ñº</span>
        </div>
        <div class="custom-theme-panel" id="customThemePanel">
          <div class="color-input-group">
            <label>Primary Background</label>
            <div class="color-input-wrapper">
              <input type="color" id="colorBgPrimary" onchange="updateCustomColor('bg-primary', this.value)">
              <input type="text" id="textBgPrimary" value="#313338" onchange="updateCustomColorFromText('bg-primary', this.value)">
            </div>
          </div>
          <div class="color-input-group">
            <label>Secondary Background</label>
            <div class="color-input-wrapper">
              <input type="color" id="colorBgSecondary" onchange="updateCustomColor('bg-secondary', this.value)">
              <input type="text" id="textBgSecondary" value="#2b2d31" onchange="updateCustomColorFromText('bg-secondary', this.value)">
            </div>
          </div>
          <div class="color-input-group">
            <label>Tertiary Background</label>
            <div class="color-input-wrapper">
              <input type="color" id="colorBgTertiary" onchange="updateCustomColor('bg-tertiary', this.value)">
              <input type="text" id="textBgTertiary" value="#1e1f22" onchange="updateCustomColorFromText('bg-tertiary', this.value)">
            </div>
          </div>
          <div class="color-input-group">
            <label>Primary Text</label>
            <div class="color-input-wrapper">
              <input type="color" id="colorTextPrimary" onchange="updateCustomColor('text-primary', this.value)">
              <input type="text" id="textTextPrimary" value="#dbdee1" onchange="updateCustomColorFromText('text-primary', this.value)">
            </div>
          </div>
          <div class="color-input-group">
            <label>Secondary Text</label>
            <div class="color-input-wrapper">
              <input type="color" id="colorTextSecondary" onchange="updateCustomColor('text-secondary', this.value)">
              <input type="text" id="textTextSecondary" value="#949ba4" onchange="updateCustomColorFromText('text-secondary', this.value)">
            </div>
          </div>
          <div class="color-input-group">
            <label>Accent Color</label>
            <div class="color-input-wrapper">
              <input type="color" id="colorAccent" onchange="updateCustomColor('accent', this.value)">
              <input type="text" id="textAccent" value="#5865f2" onchange="updateCustomColorFromText('accent', this.value)">
            </div>
          </div>
        </div>
      </div>

      <button onclick="saveTheme()">Save Theme</button>
      <button class="cancel" onclick="closeThemeSettings()">Cancel</button>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal-overlay confirm-modal" id="deleteModal">
    <div class="modal">
      <h2>Delete Message</h2>
      <p>Are you sure you want to delete this message?</p>
      <div class="btn-row">
        <button class="cancel" onclick="closeDeleteModal()">Cancel</button>
        <button class="btn-danger" onclick="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>

  <script>
   const SUPABASE_URL = 'https://sfilmsuauhmhmlatqoqm.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmaWxtc3VhdWhtaG1sYXRxb3FtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwODM4MDksImV4cCI6MjA3OTY1OTgwOX0.H50budPYVnFIOfW63M9A9RjX4cUPlVTDh3qHkOMCCI0';
   const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
  auth: {
    persistSession: true,
    autoRefreshToken: true
  },
  db: {
    schema: 'public'
  },
  global: {
    headers: {
      'Content-Type': 'application/json'
    }
  }
});
    const REACTIONS = ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üòÆ', 'üò¢', 'üî•'];
    
    let currentUser = null;
    let usersCache = {};
    let allMessages = [];
    let reactionsCache = {};
    let onlineUsers = {};
    let isAtBottom = true;
    let replyingTo = null;
    let editingMessage = null;
    let pendingImage = null;
    let pendingAvatar = null;
    let hasUnreadMessages = false;
    let typingTimeout = null;
    let deleteMessageId = null;
    let mentionQuery = '';
    let mentionStartPos = -1;
    let selectedMentionIndex = 0;
    let customThemeExpanded = false;
    let currentThemeConfig = { preset: 'default' };

    // Theme presets
    const THEME_PRESETS = {
      default: {
        'bg-primary': '#313338',
        'bg-secondary': '#2b2d31',
        'bg-tertiary': '#1e1f22',
        'bg-input': '#383a40',
        'text-primary': '#dbdee1',
        'text-secondary': '#949ba4',
        'text-tertiary': '#6d6f78',
        'accent': '#5865f2',
        'accent-hover': '#4752c4'
      },
      christmas: {
        'bg-primary': '#1a3a1a',
        'bg-secondary': '#2d1810',
        'bg-tertiary': '#1e0f0a',
        'bg-input': '#3a1f15',
        'text-primary': '#f0e6d2',
        'text-secondary': '#c4b5a0',
        'text-tertiary': '#8a7a65',
        'accent': '#c41e3a',
        'accent-hover': '#a01830'
      }
    };

    // Favicon
    const normalFavicon = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%235865f2'/><text x='50' y='68' text-anchor='middle' font-size='50'>‚õµ</text></svg>";
    const notificationFavicon = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%235865f2'/><text x='50' y='68' text-anchor='middle' font-size='50'>‚õµ</text><circle cx='80' cy='20' r='18' fill='%23ed4245'/></svg>";

    function setFavicon(hasNotification) {
      document.getElementById('favicon').href = hasNotification ? notificationFavicon : normalFavicon;
    }

    let windowFocused = true;
    window.addEventListener('focus', () => {
      windowFocused = true;
      hasUnreadMessages = false;
      setFavicon(false);
      document.title = 'RYB Chat';
    });
    window.addEventListener('blur', () => { windowFocused = false; });

    // Theme Functions
    function applyTheme(config) {
      currentThemeConfig = config;
      
      if (config.preset && config.preset !== 'custom') {
        document.body.setAttribute('data-theme', config.preset);
        document.body.style.removeProperty('--bg-primary');
        document.body.style.removeProperty('--bg-secondary');
        document.body.style.removeProperty('--bg-tertiary');
        document.body.style.removeProperty('--bg-input');
        document.body.style.removeProperty('--text-primary');
        document.body.style.removeProperty('--text-secondary');
        document.body.style.removeProperty('--text-tertiary');
        document.body.style.removeProperty('--accent');
        document.body.style.removeProperty('--accent-hover');
      } else if (config.custom) {
        document.body.removeAttribute('data-theme');
        Object.entries(config.custom).forEach(([key, value]) => {
          document.body.style.setProperty(`--${key}`, value);
        });
      }
    }

    function openThemeSettings() {
      document.getElementById('dropdown').classList.remove('active');
      document.getElementById('themeModal').classList.add('active');
      
      // Update UI to reflect current theme
      const presets = document.querySelectorAll('.theme-preset');
      presets.forEach(p => {
        if (p.dataset.theme === currentThemeConfig.preset) {
          p.classList.add('active');
        } else {
          p.classList.remove('active');
        }
      });

      // Load custom colors if present
      if (currentThemeConfig.custom) {
        Object.entries(currentThemeConfig.custom).forEach(([key, value]) => {
          const colorInput = document.getElementById(`color${key.split('-').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join('')}`);
          const textInput = document.getElementById(`text${key.split('-').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join('')}`);
          if (colorInput) colorInput.value = value;
          if (textInput) textInput.value = value;
        });
      }
    }

    function closeThemeSettings() {
      document.getElementById('themeModal').classList.remove('active');
      customThemeExpanded = false;
      document.getElementById('customThemePanel').classList.remove('active');
      document.getElementById('expandIcon').classList.remove('expanded');
    }

    function toggleCustomTheme() {
      customThemeExpanded = !customThemeExpanded;
      document.getElementById('customThemePanel').classList.toggle('active');
      document.getElementById('expandIcon').classList.toggle('expanded');
    }

    function selectThemePreset(preset) {
      currentThemeConfig = { preset };
      applyTheme(currentThemeConfig);
      
      // Update UI
      document.querySelectorAll('.theme-preset').forEach(p => p.classList.remove('active'));
      document.querySelector(`[data-theme="${preset}"]`).classList.add('active');
    }

    function updateCustomColor(key, value) {
      if (!currentThemeConfig.custom) currentThemeConfig.custom = {};
      currentThemeConfig.custom[key] = value;
      currentThemeConfig.preset = 'custom';
      
      // Update text input
      const textInput = document.getElementById(`text${key.split('-').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join('')}`);
      if (textInput) textInput.value = value;
      
      applyTheme(currentThemeConfig);
      document.querySelectorAll('.theme-preset').forEach(p => p.classList.remove('active'));
    }

    function updateCustomColorFromText(key, value) {
      if (!value.match(/^#[0-9A-F]{6}$/i)) return;
      
      if (!currentThemeConfig.custom) currentThemeConfig.custom = {};
      currentThemeConfig.custom[key] = value;
      currentThemeConfig.preset = 'custom';
      
      // Update color input
      const colorInput = document.getElementById(`color${key.split('-').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join('')}`);
      if (colorInput) colorInput.value = value;
      
      applyTheme(currentThemeConfig);
      document.querySelectorAll('.theme-preset').forEach(p => p.classList.remove('active'));
    }

    async function saveTheme() {
      try {
        const { error } = await supabase
          .from('users')
          .update({ theme: currentThemeConfig })
          .eq('id', currentUser.id);
        
        if (error) throw error;
        
        currentUser.theme = currentThemeConfig;
        localStorage.setItem('ryb-user', JSON.stringify(currentUser));
        closeThemeSettings();
      } catch (error) {
        console.error('Save theme error:', error);
        alert('Failed to save theme');
      }
    }

    function loadUserTheme() {
      if (currentUser.theme) {
        applyTheme(currentUser.theme);
      }
    }

    // Password hashing
    async function hashPassword(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password + 'ryb-salt-2024');
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // Auth
    function showError(message) {
      const el = document.getElementById('authError');
      el.textContent = message;
      el.style.display = 'block';
    }

    function hideError() { document.getElementById('authError').style.display = 'none'; }
    function showRegister() {
      hideError();
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('registerForm').style.display = 'block';
    }
    function showLogin() {
      hideError();
      document.getElementById('registerForm').style.display = 'none';
      document.getElementById('loginForm').style.display = 'block';
    }

    async function login() {
      hideError();
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      if (!username || !password) { showError('Please enter username and password'); return; }
      try {
        const passwordHash = await hashPassword(password);
        const { data, error } = await supabase.from('users').select('*').eq('username', username).eq('password_hash', passwordHash).single();
        if (error || !data) { showError('Invalid username or password'); return; }
        currentUser = data;
        localStorage.setItem('ryb-user', JSON.stringify(data));
        showChat();
      } catch (error) {
        console.error('Login error:', error);
        showError('Login failed');
      }
    }

    async function register() {
      hideError();
      const username = document.getElementById('registerUsername').value.trim();
      const password = document.getElementById('registerPassword').value;
      const confirm = document.getElementById('registerConfirm').value;
      if (!username || !password) { showError('Please enter username and password'); return; }
      if (username.length < 3) { showError('Username must be at least 3 characters'); return; }
      if (password.length < 4) { showError('Password must be at least 4 characters'); return; }
      if (password !== confirm) { showError('Passwords do not match'); return; }
      try {
        const { data: existing } = await supabase.from('users').select('id').eq('username', username).single();
        if (existing) { showError('Username already taken'); return; }
        const passwordHash = await hashPassword(password);
        const { data, error } = await supabase.from('users').insert([{ username, password_hash: passwordHash }]).select().single();
        if (error) throw error;
        currentUser = data;
        localStorage.setItem('ryb-user', JSON.stringify(data));
        showChat();
      } catch (error) {
        console.error('Register error:', error);
        showError('Registration failed');
      }
    }

    function logout() {
      updatePresence(false, false);
      currentUser = null;
      localStorage.removeItem('ryb-user');
      document.getElementById('authScreen').style.display = 'flex';
      document.getElementById('chatScreen').classList.remove('active');
      document.getElementById('dropdown').classList.remove('active');
    }

    async function showChat() {
      document.getElementById('authScreen').style.display = 'none';
      document.getElementById('chatScreen').classList.add('active');
      loadUserTheme();
      updateUserMenu();
      await loadUsers();
      await loadMessages();
      await loadReactions();
      subscribeToAll();
      updatePresence(true, false);
      setInterval(() => updatePresence(true, false), 30000);
    }

    function updateUserMenu() {
      const avatarEl = document.getElementById('userMenuAvatar');
      const nameEl = document.getElementById('userMenuName');
      nameEl.textContent = currentUser.username;
      avatarEl.innerHTML = currentUser.avatar_url ? `<img src="${currentUser.avatar_url}">` : currentUser.username.charAt(0).toUpperCase();
    }

    function toggleDropdown() { document.getElementById('dropdown').classList.toggle('active'); }
    function toggleOnlinePanel() { document.getElementById('onlinePanel').classList.toggle('active'); }

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.user-menu') && !e.target.closest('.dropdown')) {
        document.getElementById('dropdown').classList.remove('active');
      }
      if (!e.target.closest('.online-users') && !e.target.closest('.online-panel')) {
        document.getElementById('onlinePanel').classList.remove('active');
      }
      if (!e.target.closest('.reaction-picker') && !e.target.closest('.message-action')) {
        document.querySelectorAll('.reaction-picker').forEach(p => p.classList.remove('active'));
      }
    });

    // Profile
    function openProfile() {
      document.getElementById('dropdown').classList.remove('active');
      document.getElementById('profileModal').classList.add('active');
      const preview = document.getElementById('profileAvatarPreview');
      preview.innerHTML = currentUser.avatar_url ? `<img src="${currentUser.avatar_url}">` : currentUser.username.charAt(0).toUpperCase();
    }

    function closeProfile() {
      document.getElementById('profileModal').classList.remove('active');
      pendingAvatar = null;
    }

    document.getElementById('avatarInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      if (file.size > 2 * 1024 * 1024) { alert('Avatar too large. Max 2MB.'); return; }
      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById('profileAvatarPreview').innerHTML = `<img src="${e.target.result}">`;
        pendingAvatar = file;
      };
      reader.readAsDataURL(file);
    });

    async function saveProfile() {
      if (!pendingAvatar) { closeProfile(); return; }
      try {
        const fileExt = pendingAvatar.name.split('.').pop();
        const fileName = `avatar-${currentUser.id}-${Date.now()}.${fileExt}`;
        const { error: uploadError } = await supabase.storage.from('images').upload(fileName, pendingAvatar, { cacheControl: '3600', upsert: false });
        if (uploadError) throw uploadError;
        const { data: urlData } = supabase.storage.from('images').getPublicUrl(fileName);
        const { error: updateError } = await supabase.from('users').update({ avatar_url: urlData.publicUrl }).eq('id', currentUser.id);
        if (updateError) throw updateError;
        currentUser.avatar_url = urlData.publicUrl;
        localStorage.setItem('ryb-user', JSON.stringify(currentUser));
        usersCache[currentUser.id] = currentUser;
        updateUserMenu();
        closeProfile();
      } catch (error) {
        console.error('Save profile error:', error);
        alert('Failed to save profile');
      }
    }

    // Presence
    async function updatePresence(isOnline, isTyping) {
      if (!currentUser) return;
      try {
        await supabase.from('presence').upsert({
          user_id: currentUser.id,
          username: currentUser.username,
          is_online: isOnline,
          is_typing: isTyping,
          last_seen: new Date().toISOString()
        });
      } catch (e) { console.error('Presence error:', e); }
    }

    async function loadOnlineUsers() {
      const { data } = await supabase.from('presence').select('*').eq('is_online', true);
      onlineUsers = {};
      data?.forEach(p => { onlineUsers[p.user_id] = p; });
      renderOnlineUsers();
    }

    function renderOnlineUsers() {
      const list = document.getElementById('onlineUsersList');
      const users = Object.values(onlineUsers);
      document.getElementById('onlineCountNum').textContent = users.length;
      list.innerHTML = users.map(p => {
        const user = usersCache[p.user_id] || { username: p.username, avatar_url: null };
        return `
          <div class="online-user">
            <div class="online-user-avatar">
              ${user.avatar_url ? `<img src="${user.avatar_url}">` : user.username.charAt(0).toUpperCase()}
              <div class="status-dot"></div>
            </div>
            <span class="online-user-name">${escapeHtml(user.username)}</span>
          </div>
        `;
      }).join('');
    }

    function renderTypingIndicator() {
      const indicator = document.getElementById('typingIndicator');
      const typingUsers = Object.values(onlineUsers).filter(p => p.is_typing && p.user_id !== currentUser.id);
      if (typingUsers.length === 0) {
        indicator.innerHTML = '';
        return;
      }
      const names = typingUsers.map(p => p.username);
      let text = '';
      if (names.length === 1) text = `<strong>${escapeHtml(names[0])}</strong> is typing`;
      else if (names.length === 2) text = `<strong>${escapeHtml(names[0])}</strong> and <strong>${escapeHtml(names[1])}</strong> are typing`;
      else text = `<strong>${names.length} people</strong> are typing`;
      indicator.innerHTML = `<div class="typing-dots"><span></span><span></span><span></span></div><span>${text}...</span>`;
    }

    // Utilities
    function getUserColor(username) {
      let hash = 0;
      for (let i = 0; i < username.length; i++) hash = username.charCodeAt(i) + ((hash << 5) - hash);
      return 'user-color-' + (Math.abs(hash) % 6 + 1);
    }

    function formatTime(date) {
      const now = new Date();
      const msgDate = new Date(date);
      const time = msgDate.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
      if (now.toDateString() === msgDate.toDateString()) return 'Today at ' + time;
      const yesterday = new Date(now);
      yesterday.setDate(yesterday.getDate() - 1);
      if (yesterday.toDateString() === msgDate.toDateString()) return 'Yesterday at ' + time;
      return msgDate.toLocaleDateString() + ' ' + time;
    }

    function checkScrollPosition() {
      const messages = document.getElementById('messages');
      isAtBottom = messages.scrollHeight - messages.scrollTop - messages.clientHeight < 100;
      if (isAtBottom) document.getElementById('newMsgBtn').style.display = 'none';
    }

    function scrollToBottom() {
      const messages = document.getElementById('messages');
      messages.scrollTo({ top: messages.scrollHeight, behavior: 'smooth' });
      document.getElementById('newMsgBtn').style.display = 'none';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function processMessageContent(text) {
  let escaped = escapeHtml(text);
  
  // Process mentions
  escaped = escaped.replace(/@(\w+)/g, (match, username) => {
    return `<span class="mention" data-user="${username}">${match}</span>`;
  });
  
  // Improved image regex to catch Supabase URLs better
  const imageRegex = /(https?:\/\/[^\s<>"]+\.(?:png|jpg|jpeg|gif|webp)(?:\?[^\s<>"]*)?)/gi;
  escaped = escaped.replace(imageRegex, (url) => {
    console.log('Found image URL:', url); // Debug log
    return `<img src="${url}" onclick="openImageModal('${url}')" onerror="console.error('Image load failed:', '${url}'); this.style.display='none';" loading="lazy">`;
  });
  
  return escaped;
}

    function isMentioned(content) {
      const regex = new RegExp(`@${currentUser.username}\\b`, 'i');
      return regex.test(content);
    }

    function openImageModal(url) {
      event.stopPropagation();
      document.getElementById('modalImage').src = url;
      document.getElementById('imageModal').classList.add('active');
    }

    function closeImageModal() { document.getElementById('imageModal').classList.remove('active'); }

    // Reply & Edit
    function setReply(messageId, username, text) {
      cancelEdit();
      replyingTo = { id: messageId, username, text };
      document.getElementById('replyToUser').textContent = username;
      document.getElementById('replyBar').classList.add('active');
      document.getElementById('messageInput').focus();
    }

    function cancelReply() {
      replyingTo = null;
      document.getElementById('replyBar').classList.remove('active');
    }

    function startEdit(messageId) {
      const msg = allMessages.find(m => m.id === messageId);
      if (!msg || msg.user_id !== currentUser.id) return;
      cancelReply();
      editingMessage = msg;
      document.getElementById('messageInput').value = msg.content;
      document.getElementById('editBar').classList.add('active');
      document.getElementById('messageInput').focus();
      document.getElementById(`msg-${messageId}`)?.classList.add('editing');
    }

    function cancelEdit() {
      if (editingMessage) {
        document.getElementById(`msg-${editingMessage.id}`)?.classList.remove('editing');
      }
      editingMessage = null;
      document.getElementById('messageInput').value = '';
      document.getElementById('editBar').classList.remove('active');
    }

    // Delete
    function promptDelete(messageId) {
      deleteMessageId = messageId;
      document.getElementById('deleteModal').classList.add('active');
    }

    function closeDeleteModal() {
      deleteMessageId = null;
      document.getElementById('deleteModal').classList.remove('active');
    }

    async function confirmDelete() {
      if (!deleteMessageId) return;
      try {
        await supabase.from('messages').delete().eq('id', deleteMessageId);
        document.getElementById(`msg-${deleteMessageId}`)?.remove();
        allMessages = allMessages.filter(m => m.id !== deleteMessageId);
        closeDeleteModal();
      } catch (e) {
        console.error('Delete error:', e);
        alert('Failed to delete message');
      }
    }

    // Reactions
    async function loadReactions() {
      const { data } = await supabase.from('reactions').select('*');
      reactionsCache = {};
      data?.forEach(r => {
        if (!reactionsCache[r.message_id]) reactionsCache[r.message_id] = [];
        reactionsCache[r.message_id].push(r);
      });
    }

    function getReactionsForMessage(messageId) {
      return reactionsCache[messageId] || [];
    }

    function renderReactions(messageId) {
      const reactions = getReactionsForMessage(messageId);
      if (reactions.length === 0) return '';
      const grouped = {};
      reactions.forEach(r => {
        if (!grouped[r.emoji]) grouped[r.emoji] = [];
        grouped[r.emoji].push(r.user_id);
      });
      return `<div class="reactions">${Object.entries(grouped).map(([emoji, userIds]) => {
        const isActive = userIds.includes(currentUser.id);
        return `<div class="reaction ${isActive ? 'active' : ''}" onclick="toggleReaction(${messageId}, '${emoji}')">
          <span>${emoji}</span>
          <span class="reaction-count">${userIds.length}</span>
        </div>`;
      }).join('')}</div>`;
    }

    function showReactionPicker(messageId, btn) {
      document.querySelectorAll('.reaction-picker').forEach(p => p.remove());
      const picker = document.createElement('div');
      picker.className = 'reaction-picker active';
      picker.innerHTML = REACTIONS.map(e => `<span class="reaction-option" onclick="toggleReaction(${messageId}, '${e}')">${e}</span>`).join('');
      btn.parentElement.appendChild(picker);
    }

    async function toggleReaction(messageId, emoji) {
      document.querySelectorAll('.reaction-picker').forEach(p => p.classList.remove('active'));
      const existing = getReactionsForMessage(messageId).find(r => r.emoji === emoji && r.user_id === currentUser.id);
      try {
        if (existing) {
          await supabase.from('reactions').delete().eq('id', existing.id);
          reactionsCache[messageId] = reactionsCache[messageId].filter(r => r.id !== existing.id);
        } else {
          const { data } = await supabase.from('reactions').insert([{ message_id: messageId, user_id: currentUser.id, emoji }]).select().single();
          if (!reactionsCache[messageId]) reactionsCache[messageId] = [];
          reactionsCache[messageId].push(data);
        }
        updateMessageReactions(messageId);
      } catch (e) { console.error('Reaction error:', e); }
    }

    function updateMessageReactions(messageId) {
      const msgEl = document.getElementById(`msg-${messageId}`);
      if (!msgEl) return;
      let reactionsEl = msgEl.querySelector('.reactions');
      const newReactionsHtml = renderReactions(messageId);
      if (reactionsEl) {
        if (newReactionsHtml) reactionsEl.outerHTML = newReactionsHtml;
        else reactionsEl.remove();
      } else if (newReactionsHtml) {
        msgEl.querySelector('.message-content').insertAdjacentHTML('afterend', newReactionsHtml);
      }
    }

    // Image upload
    document.getElementById('fileInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      if (file.size > 5 * 1024 * 1024) { alert('Image too large. Max 5MB.'); return; }
      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById('imagePreview').src = e.target.result;
        document.getElementById('previewInfo').textContent = file.name;
        document.getElementById('imagePreviewBar').classList.add('active');
        pendingImage = file;
      };
      reader.readAsDataURL(file);
    });

    function cancelImage() {
      pendingImage = null;
      document.getElementById('imagePreviewBar').classList.remove('active');
      document.getElementById('fileInput').value = '';
    }

    async function uploadImage(file) {
  document.getElementById('uploadProgress').textContent = 'Uploading...';
  console.log('=== UPLOAD DEBUG START ===');
  console.log('File:', file.name, 'Size:', file.size, 'Type:', file.type);
  
  try {
    const fileExt = file.name.split('.').pop();
    const fileName = `${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;
    
    console.log('Uploading to bucket: images');
    console.log('Filename:', fileName);
    
    // Try upload
    const uploadResult = await supabase.storage
      .from('images')
      .upload(fileName, file, { 
        cacheControl: '3600', 
        upsert: false 
      });
    
    console.log('Full upload result:', JSON.stringify(uploadResult, null, 2));
    
    if (uploadResult.error) {
      console.error('Upload error:', uploadResult.error);
      alert('Upload failed: ' + uploadResult.error.message);
      document.getElementById('uploadProgress').textContent = '';
      return null;
    }
    
    if (!uploadResult.data || !uploadResult.data.path) {
      console.error('No path in upload result:', uploadResult);
      alert('Upload failed - no path returned');
      document.getElementById('uploadProgress').textContent = '';
      return null;
    }
    
    console.log('Upload successful! Path:', uploadResult.data.path);
    
    const { data: urlData } = supabase.storage.from('images').getPublicUrl(uploadResult.data.path);
    console.log('Public URL:', urlData.publicUrl);
    console.log('=== UPLOAD DEBUG END ===');
    
    document.getElementById('uploadProgress').textContent = '';
    return urlData.publicUrl;
  } catch (error) {
    console.error('Upload exception:', error);
    alert('Upload exception: ' + error.message);
    document.getElementById('uploadProgress').textContent = '';
    return null;
  }
}

    // Mentions
    function showMentionSuggestions(query) {
      const container = document.getElementById('mentionSuggestions');
      const users = Object.values(usersCache).filter(u => 
        u.username.toLowerCase().includes(query.toLowerCase()) && u.id !== currentUser.id
      ).slice(0, 5);
      
      if (users.length === 0) {
        container.classList.remove('active');
        return;
      }
      
      selectedMentionIndex = 0;
      container.innerHTML = users.map((u, i) => `
        <div class="mention-suggestion ${i === 0 ? 'selected' : ''}" data-username="${u.username}" onclick="insertMention('${u.username}')">
          <div class="mention-suggestion-avatar">
            ${u.avatar_url ? `<img src="${u.avatar_url}">` : u.username.charAt(0).toUpperCase()}
          </div>
          <span class="mention-suggestion-name">${escapeHtml(u.username)}</span>
        </div>
      `).join('');
      container.classList.add('active');
    }

    function hideMentionSuggestions() {
      document.getElementById('mentionSuggestions').classList.remove('active');
      mentionStartPos = -1;
      mentionQuery = '';
    }

    function insertMention(username) {
      const input = document.getElementById('messageInput');
      const before = input.value.substring(0, mentionStartPos);
      const after = input.value.substring(input.selectionStart);
      input.value = before + '@' + username + ' ' + after;
      input.focus();
      hideMentionSuggestions();
    }

    // Messages
    async function loadUsers() {
      const { data } = await supabase.from('users').select('*');
      data?.forEach(u => usersCache[u.id] = u);
    }

    function getUser(userId) {
      return usersCache[userId] || { username: 'Unknown', avatar_url: null };
    }

    function renderAvatar(user) {
      return user.avatar_url ? `<img src="${user.avatar_url}">` : (user.username ? user.username.charAt(0).toUpperCase() : '?');
    }

    function findMessageById(id) {
      return allMessages.find(m => m.id === id);
    }

    function addMessageToUI(message, isPending = false) {
      const messagesDiv = document.getElementById('messages');
      messagesDiv.querySelector('.welcome')?.remove();
      if (!isPending && document.getElementById(`msg-${message.id}`)) return;

      const user = isPending ? currentUser : getUser(message.user_id);
      const username = message.username || user.username;
      const mentioned = isMentioned(message.content);
      const isOwn = message.user_id === currentUser.id;

      let replyHtml = '';
      if (message.reply_to) {
        const original = findMessageById(message.reply_to);
        if (original) {
          const origUser = getUser(original.user_id);
          const origText = original.content.length > 50 ? original.content.substring(0, 50) + '...' : original.content;
          replyHtml = `<div class="reply-context" onclick="scrollToMessage(${message.reply_to})">
            <span class="reply-author">${escapeHtml(original.username || origUser.username)}</span>
            <span class="reply-text">${escapeHtml(origText)}</span>
          </div>`;
        }
      }

      const msgEl = document.createElement('div');
      msgEl.className = `message ${isPending ? 'pending' : ''} ${mentioned ? 'mentioned' : ''}`;
      msgEl.id = isPending ? `pending-${message.id}` : `msg-${message.id}`;
      msgEl.innerHTML = `
        <div class="message-avatar">${renderAvatar(user)}</div>
        <div class="message-body">
          ${replyHtml}
          <div class="message-header">
            <span class="username ${getUserColor(username)}" onclick="setReply(${message.id}, '${escapeHtml(username)}', '${escapeHtml(message.content.substring(0, 50))}')">${escapeHtml(username)}</span>
            <span class="timestamp">${isPending ? 'Sending...' : formatTime(message.created_at)}</span>
            ${message.edited_at ? '<span class="edited-tag">(edited)</span>' : ''}
          </div>
          <div class="message-content">${processMessageContent(message.content)}</div>
          ${!isPending ? renderReactions(message.id) : ''}
        </div>
        ${!isPending ? `
          <div class="message-actions">
            <button class="message-action" onclick="showReactionPicker(${message.id}, this)">React</button>
            <button class="message-action" onclick="setReply(${message.id}, '${escapeHtml(username)}', '${escapeHtml(message.content.substring(0, 50))}')">Reply</button>
            ${isOwn ? `<button class="message-action" onclick="startEdit(${message.id})">Edit</button>` : ''}
            ${isOwn ? `<button class="message-action" onclick="promptDelete(${message.id})">Delete</button>` : ''}
          </div>
        ` : ''}
      `;
      messagesDiv.appendChild(msgEl);

      if (isAtBottom) scrollToBottom();
      else document.getElementById('newMsgBtn').style.display = 'block';
    }

    function updateMessageInUI(message) {
      const msgEl = document.getElementById(`msg-${message.id}`);
      if (!msgEl) return;
      const contentEl = msgEl.querySelector('.message-content');
      const headerEl = msgEl.querySelector('.message-header');
      contentEl.innerHTML = processMessageContent(message.content);
      if (message.edited_at && !headerEl.querySelector('.edited-tag')) {
        headerEl.insertAdjacentHTML('beforeend', '<span class="edited-tag">(edited)</span>');
      }
    }

    async function loadMessages() {
      try {
        const { data, error } = await supabase.from('messages').select('*').order('created_at', { ascending: true });
        if (error) throw error;
        allMessages = data || [];
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML = '';
        if (allMessages.length === 0) {
          messagesDiv.innerHTML = '<div class="welcome"><h2>Welcome to RYB Chat</h2><p>This is the start of your conversation.</p></div>';
        } else {
          allMessages.forEach(msg => addMessageToUI(msg));
        }
        document.getElementById('messageCount').textContent = `${allMessages.length} msgs`;
        scrollToBottom();
        await loadOnlineUsers();
      } catch (error) { console.error('Error loading messages:', error); }
    }

    function subscribeToAll() {
      supabase.channel('all-changes')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, (payload) => {
          if (payload.eventType === 'INSERT') {
            const msg = payload.new;
            if (allMessages.find(m => m.id === msg.id)) return;
            allMessages.push(msg);
            document.querySelector(`[id^="pending-"]`)?.remove();
            addMessageToUI(msg);
            document.getElementById('messageCount').textContent = `${allMessages.length} msgs`;
            if (!windowFocused && msg.user_id !== currentUser.id) {
              setFavicon(true);
              document.title = '‚óè RYB Chat';
            }
          } else if (payload.eventType === 'UPDATE') {
            const msg = payload.new;
            const idx = allMessages.findIndex(m => m.id === msg.id);
            if (idx >= 0) allMessages[idx] = msg;
            updateMessageInUI(msg);
          } else if (payload.eventType === 'DELETE') {
            const id = payload.old.id;
            document.getElementById(`msg-${id}`)?.remove();
            allMessages = allMessages.filter(m => m.id !== id);
          }
        })
        .on('postgres_changes', { event: '*', schema: 'public', table: 'presence' }, (payload) => {
          if (payload.new) onlineUsers[payload.new.user_id] = payload.new;
          if (payload.old && !payload.new) delete onlineUsers[payload.old.user_id];
          renderOnlineUsers();
          renderTypingIndicator();
        })
        .on('postgres_changes', { event: '*', schema: 'public', table: 'reactions' }, (payload) => {
          if (payload.eventType === 'INSERT') {
            const r = payload.new;
            if (!reactionsCache[r.message_id]) reactionsCache[r.message_id] = [];
            if (!reactionsCache[r.message_id].find(x => x.id === r.id)) {
              reactionsCache[r.message_id].push(r);
            }
            updateMessageReactions(r.message_id);
          } else if (payload.eventType === 'DELETE') {
            const r = payload.old;
            if (reactionsCache[r.message_id]) {
              reactionsCache[r.message_id] = reactionsCache[r.message_id].filter(x => x.id !== r.id);
            }
            updateMessageReactions(r.message_id);
          }
        })
        .on('postgres_changes', { event: '*', schema: 'public', table: 'users' }, (payload) => {
          if (payload.new) usersCache[payload.new.id] = payload.new;
        })
        .subscribe((status) => {
          const el = document.getElementById('connectionStatus');
          if (status === 'SUBSCRIBED') { el.textContent = 'Live'; el.classList.remove('disconnected'); }
          else { el.textContent = 'Reconnecting...'; el.classList.add('disconnected'); }
        });
    }

    function scrollToMessage(id) {
      const el = document.getElementById(`msg-${id}`);
      if (el) {
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        el.style.background = '#3a3a50';
        setTimeout(() => { el.style.background = ''; }, 2000);
      }
    }

    async function sendMessage() {
      let content = document.getElementById('messageInput').value.trim();

      if (editingMessage) {
        if (!content) { cancelEdit(); return; }
        try {
          await supabase.from('messages').update({ content, edited_at: new Date().toISOString() }).eq('id', editingMessage.id);
          cancelEdit();
        } catch (e) { console.error('Edit error:', e); alert('Failed to edit'); }
        return;
      }

      if (pendingImage) {
        const imageUrl = await uploadImage(pendingImage);
        if (imageUrl) content = content ? `${content} ${imageUrl}` : imageUrl;
        else return;
        cancelImage();
      }

      if (!content) return;

      document.getElementById('sendBtn').disabled = true;
      const tempId = Date.now();
      const pendingMessage = {
        id: tempId,
        user_id: currentUser.id,
        username: currentUser.username,
        content,
        reply_to: replyingTo?.id || null,
        created_at: new Date().toISOString()
      };
      addMessageToUI(pendingMessage, true);
      document.getElementById('messageInput').value = '';
      document.getElementById('charCount').textContent = '';
      const replyToId = replyingTo?.id || null;
      cancelReply();
      updatePresence(true, false);

      try {
        const { error } = await supabase.from('messages').insert([{
          user_id: currentUser.id,
          username: currentUser.username,
          content,
          reply_to: replyToId
        }]);
        if (error) throw error;
        document.getElementById(`pending-${tempId}`)?.remove();
      } catch (error) {
        console.error('Error sending:', error);
        document.getElementById(`pending-${tempId}`)?.remove();
        alert('Failed to send message');
      }
      document.getElementById('sendBtn').disabled = false;
    }

    // Input handling
    const messageInput = document.getElementById('messageInput');
    
    messageInput.addEventListener('input', (e) => {
      const val = e.target.value;
      const count = val.length;
      const counter = document.getElementById('charCount');
      counter.textContent = count > 400 ? `${count}/500` : '';
      counter.className = count > 480 ? 'char-count warning' : 'char-count';

      updatePresence(true, true);
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => updatePresence(true, false), 2000);

      const cursorPos = e.target.selectionStart;
      const textBeforeCursor = val.substring(0, cursorPos);
      const mentionMatch = textBeforeCursor.match(/@(\w*)$/);
      
      if (mentionMatch) {
        mentionStartPos = mentionMatch.index;
        mentionQuery = mentionMatch[1];
        showMentionSuggestions(mentionQuery);
      } else {
        hideMentionSuggestions();
      }
    });

    messageInput.addEventListener('keydown', (e) => {
      const suggestions = document.getElementById('mentionSuggestions');
      const isShowingSuggestions = suggestions.classList.contains('active');
      
      if (isShowingSuggestions) {
        const items = suggestions.querySelectorAll('.mention-suggestion');
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          items[selectedMentionIndex]?.classList.remove('selected');
          selectedMentionIndex = (selectedMentionIndex + 1) % items.length;
          items[selectedMentionIndex]?.classList.add('selected');
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          items[selectedMentionIndex]?.classList.remove('selected');
          selectedMentionIndex = (selectedMentionIndex - 1 + items.length) % items.length;
          items[selectedMentionIndex]?.classList.add('selected');
        } else if (e.key === 'Tab' || e.key === 'Enter') {
          e.preventDefault();
          const selected = items[selectedMentionIndex];
          if (selected) insertMention(selected.dataset.username);
        } else if (e.key === 'Escape') {
          hideMentionSuggestions();
        }
      } else if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      } else if (e.key === 'Escape') {
        cancelReply();
        cancelEdit();
        cancelImage();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeImageModal();
        closeProfile();
        closeDeleteModal();
        closeThemeSettings();
      }
    });

    document.addEventListener('paste', (e) => {
      const items = e.clipboardData?.items;
      if (!items) return;
      for (const item of items) {
        if (item.type.startsWith('image/')) {
          const file = item.getAsFile();
          if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
              document.getElementById('imagePreview').src = e.target.result;
              document.getElementById('previewInfo').textContent = 'Pasted image';
              document.getElementById('imagePreviewBar').classList.add('active');
              pendingImage = file;
            };
            reader.readAsDataURL(file);
          }
          break;
        }
      }
    });

    document.getElementById('messages').addEventListener('scroll', checkScrollPosition);

    // Init
    const savedUser = localStorage.getItem('ryb-user');
    if (savedUser) {
      try {
        currentUser = JSON.parse(savedUser);
        showChat();
      } catch (e) { localStorage.removeItem('ryb-user'); }
    }

    window.addEventListener('beforeunload', () => updatePresence(false, false));
  </script>
</body>
</html>
