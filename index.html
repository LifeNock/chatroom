<!DOCTYPE html>
<html>
<head>
  <title>RYB Chat</title>
  <link rel="icon" id="favicon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%235865f2'/><text x='50' y='68' text-anchor='middle' font-size='50'>â›µ</text></svg>">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #313338;
      color: #dbdee1;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Auth Screen */
    .auth-container {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: #313338;
    }

    .auth-box {
      background: #2b2d31;
      padding: 32px;
      border-radius: 8px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }

    .auth-box h1 {
      text-align: center;
      margin-bottom: 8px;
      color: #f2f3f5;
      font-size: 24px;
    }

    .auth-box .subtitle {
      text-align: center;
      color: #949ba4;
      margin-bottom: 24px;
      font-size: 14px;
    }

    .auth-box input {
      width: 100%;
      padding: 12px;
      margin-bottom: 12px;
      border: none;
      border-radius: 4px;
      background: #1e1f22;
      color: #dbdee1;
      font-size: 15px;
    }

    .auth-box input::placeholder {
      color: #6d6f78;
    }

    .auth-box input:focus {
      outline: 2px solid #5865f2;
    }

    .auth-box button {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 4px;
      background: #5865f2;
      color: white;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 12px;
      transition: background 0.15s;
    }

    .auth-box button:hover {
      background: #4752c4;
    }

    .auth-box button.secondary {
      background: transparent;
      border: 1px solid #4e5058;
      color: #dbdee1;
    }

    .auth-box button.secondary:hover {
      background: #3a3c41;
    }

    .auth-box .error {
      color: #f47067;
      font-size: 13px;
      margin-bottom: 12px;
      text-align: center;
    }

    .auth-box .divider {
      text-align: center;
      color: #6d6f78;
      margin: 16px 0;
      font-size: 13px;
    }

    /* Chat Container */
    .chat-container {
      display: none;
      flex-direction: column;
      height: 100vh;
    }

    .chat-container.active {
      display: flex;
    }

    .header {
      background: #2b2d31;
      padding: 12px 16px;
      border-bottom: 1px solid #1e1f22;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-icon {
      width: 24px;
      height: 24px;
      background: #5865f2;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .header h1 {
      font-size: 16px;
      font-weight: 600;
      color: #f2f3f5;
    }

    .connection-status {
      margin-left: 8px;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      background: #57ab5a;
      color: #fff;
    }

    .connection-status.disconnected {
      background: #f47067;
    }

    .header-right {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .online-count {
      font-size: 12px;
      color: #949ba4;
    }

    .user-menu {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background 0.15s;
    }

    .user-menu:hover {
      background: #3a3c41;
    }

    .user-menu-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #5865f2;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      color: white;
      overflow: hidden;
    }

    .user-menu-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .user-menu-name {
      font-size: 13px;
      color: #f2f3f5;
    }

    .dropdown {
      position: absolute;
      top: 50px;
      right: 16px;
      background: #1e1f22;
      border-radius: 8px;
      padding: 8px;
      min-width: 180px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      display: none;
      z-index: 100;
    }

    .dropdown.active {
      display: block;
    }

    .dropdown-item {
      padding: 10px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      color: #dbdee1;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .dropdown-item:hover {
      background: #3a3c41;
    }

    .dropdown-item.danger {
      color: #f47067;
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    #messages::-webkit-scrollbar {
      width: 8px;
    }

    #messages::-webkit-scrollbar-track {
      background: #2b2d31;
      border-radius: 4px;
    }

    #messages::-webkit-scrollbar-thumb {
      background: #1a1b1e;
      border-radius: 4px;
    }

    .message {
      padding: 8px 12px;
      border-radius: 4px;
      animation: messageIn 0.2s ease-out;
      transition: background 0.1s;
      position: relative;
      display: flex;
      gap: 12px;
    }

    .message.pending {
      opacity: 0.6;
    }

    .message:hover {
      background: #2e3035;
    }

    .message:hover .reply-btn {
      opacity: 1;
    }

    @keyframes messageIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #5865f2;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 600;
      color: white;
      flex-shrink: 0;
      overflow: hidden;
    }

    .message-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .message-body {
      flex: 1;
      min-width: 0;
    }

    .message-header {
      display: flex;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 4px;
    }

    .username {
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
    }

    .username:hover {
      text-decoration: underline;
    }

    .timestamp {
      font-size: 11px;
      color: #949ba4;
    }

    .message-content {
      font-size: 15px;
      line-height: 1.4;
      color: #dbdee1;
      word-wrap: break-word;
    }

    .message-content img {
      max-width: 400px;
      max-height: 300px;
      border-radius: 8px;
      margin-top: 8px;
      cursor: pointer;
      transition: transform 0.1s;
      display: block;
    }

    .message-content img:hover {
      transform: scale(1.02);
    }

    .reply-context {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 8px;
      margin-bottom: 4px;
      font-size: 13px;
      color: #949ba4;
      border-left: 2px solid #4e5058;
      background: rgba(0,0,0,0.1);
      border-radius: 0 4px 4px 0;
      cursor: pointer;
    }

    .reply-context:hover {
      background: rgba(0,0,0,0.2);
    }

    .reply-context .reply-author {
      color: #00a8fc;
      font-weight: 600;
    }

    .reply-context .reply-text {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 300px;
    }

    .reply-btn {
      position: absolute;
      right: 8px;
      top: 8px;
      background: #2b2d31;
      border: none;
      color: #b5bac1;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.1s, background 0.1s;
    }

    .reply-btn:hover {
      background: #404249;
      color: #fff;
    }

    .user-color-1 { color: #f47067; }
    .user-color-2 { color: #57ab5a; }
    .user-color-3 { color: #6cb6ff; }
    .user-color-4 { color: #dcbdfb; }
    .user-color-5 { color: #f69d50; }
    .user-color-6 { color: #fc8dc7; }

    #typingIndicator {
      padding: 8px 16px;
      font-size: 13px;
      color: #949ba4;
      height: 24px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #replyBar {
      display: none;
      padding: 8px 16px;
      background: #2b2d31;
      border-top: 1px solid #1e1f22;
      align-items: center;
      gap: 12px;
      animation: slideIn 0.15s ease-out;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    #replyBar.active {
      display: flex;
    }

    #replyBar .reply-preview {
      flex: 1;
      font-size: 13px;
      color: #949ba4;
    }

    #replyBar .reply-preview strong {
      color: #00a8fc;
    }

    #replyBar .cancel-reply {
      background: none;
      border: none;
      color: #949ba4;
      cursor: pointer;
      font-size: 18px;
      padding: 4px;
    }

    #replyBar .cancel-reply:hover {
      color: #fff;
    }

    #imagePreviewBar {
      display: none;
      padding: 8px 16px;
      background: #2b2d31;
      border-top: 1px solid #1e1f22;
      align-items: center;
      gap: 12px;
      animation: slideIn 0.15s ease-out;
    }

    #imagePreviewBar.active {
      display: flex;
    }

    #imagePreviewBar img {
      max-height: 60px;
      max-width: 100px;
      border-radius: 4px;
    }

    #imagePreviewBar .preview-info {
      flex: 1;
      font-size: 13px;
      color: #949ba4;
    }

    #imagePreviewBar .cancel-image {
      background: none;
      border: none;
      color: #949ba4;
      cursor: pointer;
      font-size: 18px;
      padding: 4px;
    }

    #imagePreviewBar .cancel-image:hover {
      color: #fff;
    }

    .input-container {
      padding: 0 16px 24px;
    }

    .input-wrapper {
      background: #383a40;
      border-radius: 8px;
      display: flex;
      align-items: center;
      padding: 4px 12px;
    }

    .input-wrapper:focus-within {
      box-shadow: 0 0 0 2px #5865f2;
    }

    .upload-btn {
      background: none;
      border: none;
      color: #b5bac1;
      cursor: pointer;
      padding: 8px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.15s, background 0.15s;
      margin-right: 8px;
    }

    .upload-btn:hover {
      color: #fff;
      background: #4e5058;
    }

    .upload-btn svg {
      width: 20px;
      height: 20px;
    }

    #messageInput {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: #dbdee1;
      font-size: 15px;
      padding: 11px 0;
    }

    #messageInput::placeholder {
      color: #6d6f78;
    }

    .char-count {
      font-size: 12px;
      color: #6d6f78;
      margin-right: 8px;
    }

    .char-count.warning { color: #f47067; }

    #sendBtn {
      background: #5865f2;
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s;
    }

    #sendBtn:hover {
      background: #4752c4;
    }

    #sendBtn:disabled {
      background: #4e5058;
      cursor: not-allowed;
    }

    #sendBtn svg {
      width: 18px;
      height: 18px;
    }

    .welcome {
      text-align: center;
      padding: 40px 20px;
      color: #949ba4;
    }

    .welcome h2 {
      color: #f2f3f5;
      font-size: 24px;
      margin-bottom: 8px;
    }

    .welcome p {
      font-size: 14px;
    }

    #newMsgBtn {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: #5865f2;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      cursor: pointer;
      display: none;
      animation: fadeIn 0.2s;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateX(-50%) translateY(10px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    #imageModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 1000;
      cursor: zoom-out;
      align-items: center;
      justify-content: center;
    }

    #imageModal.active {
      display: flex;
    }

    #imageModal img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 8px;
    }

    .upload-progress {
      font-size: 12px;
      color: #949ba4;
      margin-right: 8px;
    }

    #fileInput, #avatarInput {
      display: none;
    }

    /* Profile Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 500;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: #2b2d31;
      border-radius: 8px;
      padding: 24px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }

    .modal h2 {
      color: #f2f3f5;
      margin-bottom: 20px;
      font-size: 20px;
    }

    .modal .avatar-upload {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal .avatar-preview {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: #5865f2;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      font-weight: 600;
      color: white;
      margin-bottom: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: opacity 0.15s;
    }

    .modal .avatar-preview:hover {
      opacity: 0.8;
    }

    .modal .avatar-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .modal .avatar-hint {
      font-size: 12px;
      color: #949ba4;
    }

    .modal button {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 4px;
      background: #5865f2;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 12px;
    }

    .modal button:hover {
      background: #4752c4;
    }

    .modal button.cancel {
      background: transparent;
      color: #949ba4;
    }

    .modal button.cancel:hover {
      color: #f2f3f5;
    }
  </style>
</head>
<body>
  <!-- Auth Screen -->
  <div class="auth-container" id="authScreen">
    <div class="auth-box">
      <h1>â›µ RYB Chat</h1>
      <p class="subtitle">Row Your Boat Team Chat</p>
      
      <div id="authError" class="error" style="display: none;"></div>
      
      <div id="loginForm">
        <input type="text" id="loginUsername" placeholder="Username" autocomplete="off">
        <input type="password" id="loginPassword" placeholder="Password">
        <button onclick="login()">Log In</button>
        <div class="divider">or</div>
        <button class="secondary" onclick="showRegister()">Create Account</button>
      </div>
      
      <div id="registerForm" style="display: none;">
        <input type="text" id="registerUsername" placeholder="Username" autocomplete="off">
        <input type="password" id="registerPassword" placeholder="Password">
        <input type="password" id="registerConfirm" placeholder="Confirm Password">
        <button onclick="register()">Create Account</button>
        <div class="divider">or</div>
        <button class="secondary" onclick="showLogin()">Back to Login</button>
      </div>
    </div>
  </div>

  <!-- Chat Screen -->
  <div class="chat-container" id="chatScreen">
    <div class="header">
      <div class="header-icon">â›µ</div>
      <h1>RYB Chat</h1>
      <span class="connection-status" id="connectionStatus">Live</span>
      <div class="header-right">
        <span class="online-count" id="onlineCount"></span>
        <div class="user-menu" onclick="toggleDropdown()">
          <div class="user-menu-avatar" id="userMenuAvatar"></div>
          <span class="user-menu-name" id="userMenuName"></span>
        </div>
      </div>
      <div class="dropdown" id="dropdown">
        <div class="dropdown-item" onclick="openProfile()">
          <span>ðŸ‘¤</span> Edit Profile
        </div>
        <div class="dropdown-item danger" onclick="logout()">
          <span>ðŸšª</span> Log Out
        </div>
      </div>
    </div>

    <div id="messages">
      <div class="welcome">
        <h2>Welcome to RYB Chat</h2>
        <p>This is the start of your conversation.</p>
      </div>
    </div>

    <div id="typingIndicator"></div>

    <button id="newMsgBtn" onclick="scrollToBottom()">New messages â†“</button>

    <div id="replyBar">
      <div class="reply-preview">
        Replying to <strong id="replyToUser"></strong>
      </div>
      <button class="cancel-reply" onclick="cancelReply()">Ã—</button>
    </div>

    <div id="imagePreviewBar">
      <img id="imagePreview" src="">
      <div class="preview-info" id="previewInfo">image.png</div>
      <button class="cancel-image" onclick="cancelImage()">Ã—</button>
    </div>

    <div class="input-container">
      <div class="input-wrapper">
        <input type="file" id="fileInput" accept="image/*">
        <button class="upload-btn" onclick="document.getElementById('fileInput').click()" title="Upload image">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <circle cx="8.5" cy="8.5" r="1.5"></circle>
            <polyline points="21 15 16 10 5 21"></polyline>
          </svg>
        </button>
        <input type="text" id="messageInput" placeholder="Message #ryb-chat" maxlength="500" autocomplete="off">
        <span class="char-count" id="charCount"></span>
        <span class="upload-progress" id="uploadProgress"></span>
        <button id="sendBtn" onclick="sendMessage()">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Image Modal -->
  <div id="imageModal" onclick="closeImageModal()">
    <img id="modalImage" src="">
  </div>

  <!-- Profile Modal -->
  <div class="modal-overlay" id="profileModal">
    <div class="modal">
      <h2>Edit Profile</h2>
      <div class="avatar-upload">
        <div class="avatar-preview" id="profileAvatarPreview" onclick="document.getElementById('avatarInput').click()"></div>
        <input type="file" id="avatarInput" accept="image/*">
        <span class="avatar-hint">Click to change avatar</span>
      </div>
      <button onclick="saveProfile()">Save</button>
      <button class="cancel" onclick="closeProfile()">Cancel</button>
    </div>
  </div>

  <script>
    // Supabase setup
    const SUPABASE_URL = 'https://sfilmsuauhmhmlatqoqm.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmaWxtc3VhdWhtaG1sYXRxb3FtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwODM4MDksImV4cCI6MjA3OTY1OTgwOX0.H50budPYVnFIOfW63M9A9RjX4cUPlVTDh3qHkOMCCI0';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let currentUser = null;
    let usersCache = {};
    let allMessages = [];
    let isAtBottom = true;
    let replyingTo = null;
    let pendingImage = null;
    let pendingAvatar = null;
    let hasUnreadMessages = false;

    // Favicon management
    const normalFavicon = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%235865f2'/><text x='50' y='68' text-anchor='middle' font-size='50'>â›µ</text></svg>";
    const notificationFavicon = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%235865f2'/><text x='50' y='68' text-anchor='middle' font-size='50'>â›µ</text><circle cx='80' cy='20' r='18' fill='%23ed4245'/></svg>";

    function setFavicon(hasNotification) {
      document.getElementById('favicon').href = hasNotification ? notificationFavicon : normalFavicon;
    }

    let windowFocused = true;
    window.addEventListener('focus', () => {
      windowFocused = true;
      hasUnreadMessages = false;
      setFavicon(false);
      document.title = 'RYB Chat';
    });
    window.addEventListener('blur', () => {
      windowFocused = false;
    });

    // Simple hash function for passwords (not cryptographically secure, but fine for this use case)
    async function hashPassword(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password + 'ryb-salt-2024');
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // Auth functions
    function showError(message) {
      const errorEl = document.getElementById('authError');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
    }

    function hideError() {
      document.getElementById('authError').style.display = 'none';
    }

    function showRegister() {
      hideError();
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('registerForm').style.display = 'block';
    }

    function showLogin() {
      hideError();
      document.getElementById('registerForm').style.display = 'none';
      document.getElementById('loginForm').style.display = 'block';
    }

    async function login() {
      hideError();
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      
      if (!username || !password) {
        showError('Please enter username and password');
        return;
      }
      
      try {
        const passwordHash = await hashPassword(password);
        
        const { data, error } = await supabase
          .from('users')
          .select('*')
          .eq('username', username)
          .eq('password_hash', passwordHash)
          .single();
        
        if (error || !data) {
          showError('Invalid username or password');
          return;
        }
        
        currentUser = data;
        localStorage.setItem('ryb-user', JSON.stringify(data));
        showChat();
        
      } catch (error) {
        console.error('Login error:', error);
        showError('Login failed. Please try again.');
      }
    }

    async function register() {
      hideError();
      const username = document.getElementById('registerUsername').value.trim();
      const password = document.getElementById('registerPassword').value;
      const confirm = document.getElementById('registerConfirm').value;
      
      if (!username || !password) {
        showError('Please enter username and password');
        return;
      }
      
      if (username.length < 3) {
        showError('Username must be at least 3 characters');
        return;
      }
      
      if (password.length < 4) {
        showError('Password must be at least 4 characters');
        return;
      }
      
      if (password !== confirm) {
        showError('Passwords do not match');
        return;
      }
      
      try {
        // Check if username exists
        const { data: existing } = await supabase
          .from('users')
          .select('id')
          .eq('username', username)
          .single();
        
        if (existing) {
          showError('Username already taken');
          return;
        }
        
        const passwordHash = await hashPassword(password);
        
        const { data, error } = await supabase
          .from('users')
          .insert([{ username, password_hash: passwordHash }])
          .select()
          .single();
        
        if (error) throw error;
        
        currentUser = data;
        localStorage.setItem('ryb-user', JSON.stringify(data));
        showChat();
        
      } catch (error) {
        console.error('Register error:', error);
        showError('Registration failed. Please try again.');
      }
    }

    function logout() {
      currentUser = null;
      localStorage.removeItem('ryb-user');
      document.getElementById('authScreen').style.display = 'flex';
      document.getElementById('chatScreen').classList.remove('active');
      document.getElementById('dropdown').classList.remove('active');
    }

    function showChat() {
      document.getElementById('authScreen').style.display = 'none';
      document.getElementById('chatScreen').classList.add('active');
      updateUserMenu();
      loadMessages();
      subscribeToMessages();
    }

    function updateUserMenu() {
      const avatarEl = document.getElementById('userMenuAvatar');
      const nameEl = document.getElementById('userMenuName');
      
      nameEl.textContent = currentUser.username;
      
      if (currentUser.avatar_url) {
        avatarEl.innerHTML = `<img src="${currentUser.avatar_url}">`;
      } else {
        avatarEl.textContent = currentUser.username.charAt(0).toUpperCase();
      }
    }

    function toggleDropdown() {
      document.getElementById('dropdown').classList.toggle('active');
    }

    // Close dropdown when clicking elsewhere
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.user-menu') && !e.target.closest('.dropdown')) {
        document.getElementById('dropdown').classList.remove('active');
      }
    });

    // Profile functions
    function openProfile() {
      document.getElementById('dropdown').classList.remove('active');
      document.getElementById('profileModal').classList.add('active');
      
      const preview = document.getElementById('profileAvatarPreview');
      if (currentUser.avatar_url) {
        preview.innerHTML = `<img src="${currentUser.avatar_url}">`;
      } else {
        preview.textContent = currentUser.username.charAt(0).toUpperCase();
      }
    }

    function closeProfile() {
      document.getElementById('profileModal').classList.remove('active');
      pendingAvatar = null;
    }

    document.getElementById('avatarInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      if (file.size > 2 * 1024 * 1024) {
        alert('Avatar too large. Max 2MB.');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById('profileAvatarPreview').innerHTML = `<img src="${e.target.result}">`;
        pendingAvatar = file;
      };
      reader.readAsDataURL(file);
    });

    async function saveProfile() {
      if (!pendingAvatar) {
        closeProfile();
        return;
      }
      
      try {
        // Upload avatar
        const fileExt = pendingAvatar.name.split('.').pop();
        const fileName = `avatar-${currentUser.id}-${Date.now()}.${fileExt}`;
        
        const { error: uploadError } = await supabase.storage
          .from('images')
          .upload(fileName, pendingAvatar, { cacheControl: '3600', upsert: false });
        
        if (uploadError) throw uploadError;
        
        const { data: urlData } = supabase.storage.from('images').getPublicUrl(fileName);
        
        // Update user
        const { error: updateError } = await supabase
          .from('users')
          .update({ avatar_url: urlData.publicUrl })
          .eq('id', currentUser.id);
        
        if (updateError) throw updateError;
        
        currentUser.avatar_url = urlData.publicUrl;
        localStorage.setItem('ryb-user', JSON.stringify(currentUser));
        usersCache[currentUser.id] = currentUser;
        updateUserMenu();
        closeProfile();
        
      } catch (error) {
        console.error('Save profile error:', error);
        alert('Failed to save profile');
      }
    }

    // Chat functions
    function getUserColor(username) {
      let hash = 0;
      for (let i = 0; i < username.length; i++) {
        hash = username.charCodeAt(i) + ((hash << 5) - hash);
      }
      return 'user-color-' + (Math.abs(hash) % 6 + 1);
    }

    function formatTime(date) {
      const now = new Date();
      const msgDate = new Date(date);
      const isToday = now.toDateString() === msgDate.toDateString();
      
      const time = msgDate.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
      
      if (isToday) return 'Today at ' + time;
      
      const yesterday = new Date(now);
      yesterday.setDate(yesterday.getDate() - 1);
      if (yesterday.toDateString() === msgDate.toDateString()) return 'Yesterday at ' + time;
      
      return msgDate.toLocaleDateString() + ' ' + time;
    }

    function checkScrollPosition() {
      const messages = document.getElementById('messages');
      const threshold = 100;
      isAtBottom = messages.scrollHeight - messages.scrollTop - messages.clientHeight < threshold;
      if (isAtBottom) document.getElementById('newMsgBtn').style.display = 'none';
    }

    function scrollToBottom() {
      const messages = document.getElementById('messages');
      messages.scrollTo({ top: messages.scrollHeight, behavior: 'smooth' });
      document.getElementById('newMsgBtn').style.display = 'none';
    }

    function processMessageContent(text) {
      const escaped = escapeHtml(text);
      const imageRegex = /(https?:\/\/[^\s]+\.(?:png|jpg|jpeg|gif|webp)(?:\?[^\s]*)?|https?:\/\/[^\s]*supabase[^\s]*\/storage\/[^\s]+)/gi;
      return escaped.replace(imageRegex, (url) => {
        return `<img src="${url}" onclick="openImageModal('${url}')" onerror="this.style.display='none'" loading="lazy">`;
      });
    }

    function openImageModal(url) {
      event.stopPropagation();
      document.getElementById('modalImage').src = url;
      document.getElementById('imageModal').classList.add('active');
    }

    function closeImageModal() {
      document.getElementById('imageModal').classList.remove('active');
    }

    function setReply(messageId, username, text) {
      replyingTo = { id: messageId, username, text };
      document.getElementById('replyToUser').textContent = username;
      document.getElementById('replyBar').classList.add('active');
      document.getElementById('messageInput').focus();
    }

    function cancelReply() {
      replyingTo = null;
      document.getElementById('replyBar').classList.remove('active');
    }

    document.getElementById('fileInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      if (file.size > 5 * 1024 * 1024) {
        alert('Image too large. Max 5MB.');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById('imagePreview').src = e.target.result;
        document.getElementById('previewInfo').textContent = file.name;
        document.getElementById('imagePreviewBar').classList.add('active');
        pendingImage = file;
      };
      reader.readAsDataURL(file);
    });

    function cancelImage() {
      pendingImage = null;
      document.getElementById('imagePreviewBar').classList.remove('active');
      document.getElementById('fileInput').value = '';
    }

    async function uploadImage(file) {
      document.getElementById('uploadProgress').textContent = 'Uploading...';
      
      try {
        const fileExt = file.name.split('.').pop();
        const fileName = `${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;
        
        const { data, error } = await supabase.storage
          .from('images')
          .upload(fileName, file, { cacheControl: '3600', upsert: false });
        
        if (error) throw error;
        
        const { data: urlData } = supabase.storage.from('images').getPublicUrl(fileName);
        
        document.getElementById('uploadProgress').textContent = '';
        return urlData.publicUrl;
        
      } catch (error) {
        console.error('Upload error:', error);
        document.getElementById('uploadProgress').textContent = 'Upload failed';
        setTimeout(() => {
          document.getElementById('uploadProgress').textContent = '';
        }, 3000);
        return null;
      }
    }

    function findMessageById(id) {
      return allMessages.find(m => m.id === id);
    }

    function getUser(userId) {
      return usersCache[userId] || { username: 'Unknown', avatar_url: null };
    }

    function renderAvatar(user) {
      if (user.avatar_url) {
        return `<img src="${user.avatar_url}">`;
      }
      return user.username ? user.username.charAt(0).toUpperCase() : '?';
    }

    function addMessageToUI(message, isPending = false) {
      const messagesDiv = document.getElementById('messages');
      
      const welcome = messagesDiv.querySelector('.welcome');
      if (welcome) welcome.remove();
      
      if (!isPending && document.getElementById(`msg-${message.id}`)) return;
      
      const user = isPending ? currentUser : getUser(message.user_id);
      const username = message.username || user.username;
      
      let replyHtml = '';
      if (message.reply_to) {
        const original = findMessageById(message.reply_to);
        if (original) {
          const origUser = getUser(original.user_id);
          const origText = original.content.length > 50 ? original.content.substring(0, 50) + '...' : original.content;
          replyHtml = `
            <div class="reply-context" onclick="scrollToMessage(${message.reply_to})">
              <span class="reply-author">${escapeHtml(original.username || origUser.username)}</span>
              <span class="reply-text">${escapeHtml(origText)}</span>
            </div>
          `;
        }
      }
      
      const msgEl = document.createElement('div');
      msgEl.className = isPending ? 'message pending' : 'message';
      msgEl.id = isPending ? `pending-${message.id}` : `msg-${message.id}`;
      msgEl.innerHTML = `
        <div class="message-avatar">${renderAvatar(user)}</div>
        <div class="message-body">
          ${replyHtml}
          <div class="message-header">
            <span class="username ${getUserColor(username)}" onclick="setReply(${message.id}, '${escapeHtml(username)}', '${escapeHtml(message.content.substring(0, 50))}')">${escapeHtml(username)}</span>
            <span class="timestamp">${isPending ? 'Sending...' : formatTime(message.created_at)}</span>
          </div>
          <div class="message-content">${processMessageContent(message.content)}</div>
        </div>
        ${!isPending ? `<button class="reply-btn" onclick="setReply(${message.id}, '${escapeHtml(username)}', '${escapeHtml(message.content.substring(0, 50))}')">Reply</button>` : ''}
      `;
      messagesDiv.appendChild(msgEl);
      
      if (isAtBottom) {
        scrollToBottom();
      } else {
        document.getElementById('newMsgBtn').style.display = 'block';
      }
    }

    async function loadMessages() {
      try {
        // Load users first
        const { data: users } = await supabase.from('users').select('*');
        users?.forEach(u => usersCache[u.id] = u);
        
        // Load messages
        const { data, error } = await supabase
          .from('messages')
          .select('*')
          .order('created_at', { ascending: true });
        
        if (error) throw error;
        
        allMessages = data || [];
        
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML = '';
        
        if (allMessages.length === 0) {
          messagesDiv.innerHTML = `
            <div class="welcome">
              <h2>Welcome to RYB Chat</h2>
              <p>This is the start of your conversation.</p>
            </div>
          `;
        } else {
          allMessages.forEach(msg => addMessageToUI(msg));
        }
        
        document.getElementById('onlineCount').textContent = `${allMessages.length} messages`;
        scrollToBottom();
        
      } catch (error) {
        console.error('Error loading messages:', error);
      }
    }

    function subscribeToMessages() {
      supabase
        .channel('messages-channel')
        .on('postgres_changes', 
          { event: 'INSERT', schema: 'public', table: 'messages' },
          (payload) => {
            const newMessage = payload.new;
            
            if (allMessages.find(m => m.id === newMessage.id)) return;
            
            allMessages.push(newMessage);
            
            // Remove pending version
            const pendingEl = document.querySelector(`[id^="pending-"]`);
            if (pendingEl) pendingEl.remove();
            
            addMessageToUI(newMessage);
            document.getElementById('onlineCount').textContent = `${allMessages.length} messages`;
            
            // Notification
            if (!windowFocused && newMessage.user_id !== currentUser.id) {
              hasUnreadMessages = true;
              setFavicon(true);
              document.title = 'â— RYB Chat';
            }
          }
        )
        .on('postgres_changes',
          { event: '*', schema: 'public', table: 'users' },
          (payload) => {
            if (payload.new) {
              usersCache[payload.new.id] = payload.new;
            }
          }
        )
        .subscribe((status) => {
          const statusEl = document.getElementById('connectionStatus');
          if (status === 'SUBSCRIBED') {
            statusEl.textContent = 'Live';
            statusEl.classList.remove('disconnected');
          } else if (status === 'CLOSED' || status === 'CHANNEL_ERROR') {
            statusEl.textContent = 'Reconnecting...';
            statusEl.classList.add('disconnected');
          }
        });
    }

    function scrollToMessage(id) {
      const el = document.getElementById(`msg-${id}`);
      if (el) {
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        el.style.background = '#3a3a50';
        setTimeout(() => { el.style.background = ''; }, 2000);
      }
    }

    async function sendMessage() {
      let content = document.getElementById('messageInput').value.trim();
      
      if (pendingImage) {
        const imageUrl = await uploadImage(pendingImage);
        if (imageUrl) {
          content = content ? `${content} ${imageUrl}` : imageUrl;
        } else {
          return;
        }
        cancelImage();
      }
      
      if (!content) return;
      
      document.getElementById('sendBtn').disabled = true;
      
      const tempId = Date.now();
      const pendingMessage = {
        id: tempId,
        user_id: currentUser.id,
        username: currentUser.username,
        content,
        reply_to: replyingTo?.id || null,
        created_at: new Date().toISOString()
      };
      addMessageToUI(pendingMessage, true);
      
      document.getElementById('messageInput').value = '';
      document.getElementById('charCount').textContent = '';
      const replyToId = replyingTo?.id || null;
      cancelReply();
      
      try {
        const { error } = await supabase
          .from('messages')
          .insert([{
            user_id: currentUser.id,
            username: currentUser.username,
            content,
            reply_to: replyToId
          }]);
        
        if (error) throw error;
        
        const pendingEl = document.getElementById(`pending-${tempId}`);
        if (pendingEl) pendingEl.remove();
        
      } catch (error) {
        console.error('Error sending:', error);
        const pendingEl = document.getElementById(`pending-${tempId}`);
        if (pendingEl) pendingEl.remove();
        alert('Failed to send message');
      }
      
      document.getElementById('sendBtn').disabled = false;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Event listeners
    document.getElementById('messageInput').addEventListener('input', (e) => {
      const count = e.target.value.length;
      const counter = document.getElementById('charCount');
      if (count > 400) {
        counter.textContent = `${count}/500`;
        counter.className = count > 480 ? 'char-count warning' : 'char-count';
      } else {
        counter.textContent = '';
      }
    });

    document.getElementById('messageInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        cancelReply();
        cancelImage();
        closeImageModal();
        closeProfile();
      }
    });

    document.addEventListener('paste', (e) => {
      const items = e.clipboardData?.items;
      if (!items) return;
      
      for (const item of items) {
        if (item.type.startsWith('image/')) {
          const file = item.getAsFile();
          if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
              document.getElementById('imagePreview').src = e.target.result;
              document.getElementById('previewInfo').textContent = 'Pasted image';
              document.getElementById('imagePreviewBar').classList.add('active');
              pendingImage = file;
            };
            reader.readAsDataURL(file);
          }
          break;
        }
      }
    });

    document.getElementById('messages').addEventListener('scroll', checkScrollPosition);

    // Check for saved session
    const savedUser = localStorage.getItem('ryb-user');
    if (savedUser) {
      try {
        currentUser = JSON.parse(savedUser);
        showChat();
      } catch (e) {
        localStorage.removeItem('ryb-user');
      }
    }
  </script>
</body>
</html>
